[ Initial_file ]
var connection = mysql.createPool({
    host     : 'localhost',
    user     : 'jin827', // CHANGE THIS :)
    password : '',
    database: 'reddit',
    connectionLimit: 10
});

// load our API and pass it the connection
var RedditAPI = require('./reddit.js');










"use strict";


            



[ Improve the getAllPosts function ]
(6)
    getAllPosts() {
        
        return this.conn.query(`
            SELECT p.title, p.url, p.userId, p.createdAt, p.updatedAt, p.subredditId, 
                   u.id, u.username, u.createdAt AS userCreate, u.updatedAt AS userUpdate,  
                   s.id, s.name, s.description, s.createdAt AS subCreate, s.updatedAt AS subUpdate
            FROM posts p
            JOIN users u ON u.id = p.userId
            JOIN subreddits s ON s.id = p.subredditId
            ORDER BY createdAt DESC
        `) 
        .then(function(data){
                console.log(data)
                return data.map( (row) => {
                return { id: row.id, 
                        title: row.title,
                        url: row.url,
                        createdAt: row.createdAt,
                        updatedAt: row.updatedAt,
                        user: {
                            id: row.userId,
                            username: row.username,
                            createdAt: row.userCreate,
                            updatedAt: row.userUpdate
                            },
                        subredditId: {
                            id: row.subredditId,
                            name: row.name,
                            description: row.description,
                            createdAt: row.subCreate,
                            updatedAt: row.subUpdate
                        }
                        }
                })
        })
    }


[ Add a subreddits functionality ]   

(1)
CREATE TABLE subreddits (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(30) UNIQUE,
  description VARCHAR(200),
  createdAt DATETIME,  
  updatedAt DATETIME 
);


(2)
-- ALTER TABLE posts ADD subredditId INT;
-- ALTER TABLE posts ADD CONSTRAINT validId FOREIGN KEY (subredditId) REFERENCES subreddits (id); 


(3)
   createSubreddits(subreddit) {
       //console.log(subreddit, "subreddit info")
       
       return this.conn.query(`
       INSERT INTO subreddits ( name, description, createdAt, updatedAt )
       VALUES ( ?, ?, NOW(), NOW() )`,
        [ subreddit.name, subreddit.description ]
       )
       .then(result => {
            console.log("create subreddit result =>", result)
            return result.insertId;
        })
        .catch(error => {
               
            if (error.code === 'ER_DUP_ENTRY') {
                throw new Error('...');
            }
            else {
                throw error;
            }
        });
       
   }
   
   
   
 (4) 
   getAllSubreddits(){
       
       return this.conn.query(`
       SELECT s.id, s.name, s.description, s.createdAt, s.updatedAt
       FROM subreddits s
       ORDER BY createdAt DESC
       `)
       .then( function(data){ 
           return data.map( row => {
                           return { id: row.id,
                                    name: row.name,
                                    description: row.description,
                                    createdAt: row.createdAt,
                                    updatedAt: row.updatedAt
                                   }  
                })
            }
       )
   }
    
}



(6)
    createPost(post) {
        if (post.subredditId === false){
            throw new Error("subredditId is not defined")
        }
        return this.conn.query(`
            INSERT INTO posts (userId, title, url, subredditId, createdAt, updatedAt)
            VALUES (?, ?, ?, ?, NOW(), NOW())`,
            [ post.userId, post.title, post.url, post.subredditId ]
        )
            .then( function(data){
                //console.log(data)
                return data.insertId;
            });
    }


